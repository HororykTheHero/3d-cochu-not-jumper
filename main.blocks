<xml xmlns="https://developers.google.com/blockly/xml"><variables><variable id="D+c|WJms(!2Y[q~|5s^a">map</variable><variable id="mLsZhrq0g2Bj4z%;wqSd">textures</variable><variable id="j@M5|/u1:h(EN)@c(W$C">t0</variable><variable id="R)2}Pf{)c%DJC3R+XMrY">i</variable><variable id="q,6kJT*-zq#)=t%U*]=r">fpx</variable><variable id="i!jlg=$[PH#A[2oloKl.">fpx_scale</variable><variable id="*btDK(#/Ff#tL;ux=l+q">fov</variable></variables><block type="pxt-on-start" id="iK^pnE#wikcUth987znb" x="0" y="0"><statement name="HANDLER"><block type="variables_set" id="$v/y3%hGr1O7Wf]/wPw`"><field name="VAR" id="D+c|WJms(!2Y[q~|5s^a">map</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="screen_image_picker" id="Y$+gQfPlUQ6SS0z:n5*a"><field name="img">img`
56666666666665656663666366666365
6.......6......................6
6.......6......................6
6...7...5......................6
6...7...6..7777777777....6666666
6...1...6..7777777777..........6
6...2...6..66666.......7.......6
6...7...6......6.......4.......6
6...1...64664666.......7.......6
6...7..................7.......6
666666666665666566..665666656666
6..............................6
6..............................6
6....7777777477777777774777....6
6....6666666666666666666666....6
6....6666266666266666266666....6
6..............................6
6..............................6
677727777771777717772777.......6
6..............................6
6............77777777777.......6
6..........777.........777777776
6..6....7777...................6
6..6....6.....77777....777.....6
6..6....6.....7...77...7.77....6
6..6....6.....77...7....7.77..76
6..6....667....7...7...7...7..76
6..6......777..7...77777...77776
6..6........7777...............6
6..............................6
6..............................6
56666666666666666666666666666665
`</field><data>{"commentRefs":[],"fieldData":{"img":"Y$+gQfPlUQ6SS0z:n5*a"}}</data></block></value><next><block type="variables_set" id=";8^up+F)MQ|ctnnL-5|X"><field name="VAR" id="mLsZhrq0g2Bj4z%;wqSd">textures</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="5N0nmA5?=*Y(DMk!d@Fw" inline="false"><mutation items="14" horizontalafter="3"></mutation><value name="ADD0"><block type="screen_image_picker" id="Z5PG-b~gj]J/B#k#d-Ed"><field name="img">img`
8888888888bbbbbb8888888888888888
8888888bbb444444bb88888888888888
888882244444ddd444b8888888888888
8888244444444dddd44e888888888888
888244444444444ddd4be88888888888
88244fffff4444444d44be8888888888
82b44fffff44444444d4be8888888888
82b44fffff4444fffff4bbe888888888
2bbb4fffff4444fffff4bbe888888888
2bbb4fffff4444fffff4bbe888888888
2bb4b444444444fffff44bbe88888888
2bb44444444444fffff444be88888888
2bb44444444444444444444e88888888
2bbb4fffff4444444444444e88888888
22bbbfffff4bb444444444be88888888
82bbbfffffbbb44444444bbe88888888
822bbfffffb44bbb444444bbe8888888
88eeefffffbb44bbb444444be8888888
888eeeeebbbbbbbb44b4444be8888888
88888eeeeee222bb44bbb4bbe8888888
8888888eeeee222bb44bbbbee8888888
888888888888e222bbbbbbbec8888888
88888888888888ee2bbbbeebdb888888
88888888888888888eeeeecdddb88888
88888888888888888888888cd11bbbb8
888888888888888888888888cd111dbb
8888888888888888888888888b11111c
8888888888888888888888888c11dd1c
8888888888888888888888888cd1dbc8
8888888888888888888888888cb11c88
88888888888888888888888888ccc888
88888888888888888888888888888888
`</field><data>{"commentRefs":[],"fieldData":{"img":"Z5PG-b~gj]J/B#k#d-Ed"}}</data></block></value><value name="ADD1"><block type="typescript_expression" id="c!Inw~%urn]M75gG[8:," editable="false"><field name="EXPRESSION">null</field></block></value><value name="ADD2"><block type="screen_image_picker" id="TN/88;*1U3rjAk-SI._%"><field name="img">img`
9999999999993333bb99bb3333399999
999999993bb31111d3b311d111d33999
99999993bdd11111dbd11d1111111399
9999999bdddd1111bd11d111dd111139
9999993d111dd111b11d111dd33d11d3
9999993fffff1dd1d11d111d11d33113
9999bb3fffff11dd13dd111d1dd3b31b
999b3d3fffff111dd13dd11d1dddbbdb
9993dddfffff1111dd133dddddddb9b9
9931111fffffd1111dfffffdddd33999
993111111d111dd111fffff1dd331399
99bddd1111ddd11dd1fffff111111399
99311ddd111dddd11dfffffd1111ddb9
9931111dd111dddd11fffffdddddddb9
999bd1111d1113ddd11dd1111111d3b9
9994dd11fffff13ddd11ddd111d333b9
994dbdddfffff1133ddddddddddddb99
94ddbdddfffff111d33ddddddddd3b99
94dddb11fffffdd111d333dddd3bb999
94dd55b1fffffdd11111d3333bbb9999
9445555b111d11dddd111111ddb99999
94455555bd1d311ddddddddddd399999
945455555bb1d3111ddddddd11399999
94554555555b333d1111111113999999
455554555555bbb33d11111d33999999
4d555545555555dbbb3d11d339999999
4dd5555455555ddddd43333999999999
45dd555544ddddddd499999999999999
945dd5555d44dddd4999999999999999
9945dd55dddd44449999999999999999
99945dd5544499999999999999999999
99994444499999999999999999999999
`</field><data>{"commentRefs":[],"fieldData":{"img":"TN/88;*1U3rjAk-SI._%"}}</data></block></value><value name="ADD3"><block type="typescript_expression" id="kBz7:0|f-j+4xxUC1N8d" editable="false"><field name="EXPRESSION">null</field></block></value><value name="ADD4"><block type="screen_image_picker" id="PkWz/_718b_WCu?r4W7V"><field name="img">img`
6666666666666666666666bbb6666666
66666666666666666666bb333b666666
66666666666666666bbb333d33b66666
6666666666666666bb333333d3a66666
66666666666666bb33332eeeedba6666
666666666666bbb333323eee2e3a6666
6666666666bbd333333e22222ed3a666
6666666bbbdd3fffff3e22222edda666
666666bb3d333fffff3be222eb3d3a66
666bbb3dd3333fffff33beeeb33d3a66
66b3ddd333333fffff333333333dda66
bbddd33333333fffff333333333dd3a6
b33dddddd333333333333fffff33d3a6
bb3333333ddddd3333333fffff33dda6
bbbbbbb333dd33dddddddfffff33ddba
b55553bfffff3333dd333fffff33dd3a
b555555fffff3bbbbbbbbfffffdddd3a
bd55555fffff55555dddbaaaaab3d3ba
bb55555fffff5555555dddddddbb33ba
b3bb355fffff555d5555d55dddddbbba
b33333bbb355dd55555d555ddddddbba
b5555d333333bbb35dddddd55ddddbba
b5d555dd5553333bbbbb3ddddddddb3a
b5d555555555555dd3333bbbbbb3db3a
bd5d555555d55555dd555ddbbbbbbb3a
bbb55dd555555555555555ddddddbb3a
666bbbbdd555ddd5555ddddddddddb3a
6666666bbbb555555d5ddd5ddddddb3a
66666666666bbbb55555555555dd533a
666666666666666bbbbddd5d55d5b3ba
6666666666666666666bbbbddddb3ba6
66666666666666666666666bbbaaaa66
`</field><data>{"commentRefs":[],"fieldData":{"img":"PkWz/_718b_WCu?r4W7V"}}</data></block></value><value name="ADD5"><block type="typescript_expression" id="LptWW4!jwIL)op#fBSWS" editable="false"><field name="EXPRESSION">null</field></block></value><value name="ADD6"><block type="screen_image_picker" id="QsVaN/IC1y:%CU?ivq`g"><field name="img">img`
11111111111111bbbbbbb11111111111
11111111111bb66663333baa11111111
111111111bb3367776333663aa111111
11111111b33333888333389633aa1111
1111111b3333333333333389633aa111
111111b34443333333333338633bae11
11111b3455433333333334443333ae11
1111b33fffff3dddd3333455233daee1
111b3d3fffffdd3bbbb33322333dabe1
11b3d33fffff3bb33bb33333333da4e1
11bd333fffffb33aab3333333223a4ee
1b3d366fffff33aafffff6332442b4ee
1bd3b983333a3aa3fffff7633ee3b4ee
1bd6983333baaa33fffff87633bb4bee
b3d6833333bba333fffff3863ba44ebe
bdd3333333bb3333fffff3333a44bebe
add6666fffff322333366333ba44bbbe
ad67776fffff2442336983d3a444b4e1
add888bfffff3ee3369833d3a44b44e1
add3333fffff333336833d3a444b4e11
a3dd333fffff33333dddd3a444b44e11
ab33ddd325543333dd33aa444b44e111
1eabb3dd32233333baaa4444b44e1111
1ebabb3d333d33baa444443b44e11111
11ebaab3ddd3aaa4444433b44e111111
11eebbaab33a44444333b444e1111111
111eeebbaab444b333b4444e11111111
1111ebeeebbbbbbbb4444ee111111111
11111eebbbb44444444ee11111111111
1111111eeebbb444eee1111111111111
1111111111eeeeee1111111111111111
11111111111111111111111111111111
`</field><data>{"commentRefs":[],"fieldData":{"img":"QsVaN/IC1y:%CU?ivq`g"}}</data></block></value><value name="ADD7"><block type="typescript_expression" id="Pu/7*f`~rOF/ZQz89?Iq" editable="false"><field name="EXPRESSION">null</field></block></value><value name="ADD8"><block type="screen_image_picker" id="m%UOjmz^IBiQZ%C-gAM6"><field name="img">img`
11111111111111111111111111111111
11111111111111111111111111111111
11111111111111111111111111111111
11111111111111111111111111111111
11111111111111111111111111111111
11111111111111111111111111111111
11111111111111111111111111111111
11111111111111111111111111111111
11111111111111111111111111111111
111111111ffffff11111111111111111
11111111feee111ff111111111111111
1111111feeee1111eff1111111111111
111111feeeee1111331f111111111111
111111feeeee11113ee1f11111111111
11111feeeeee1111eeedf11111111111
11111feeeeee111f1eedf11111111111
11111feeeee1111ffeedf11111111111
111111feeee1111eeeef111111111111
1111111f3fe1f3feeef1111111111111
1111111f33fff33ffff1111111111111
11111111ff111ff11111111111111111
11111111111111111111111111111111
111ff111ff1111111111111111111111
11f11f11f1f111111111111111111111
11111f11f11f11111111111111111111
1111f111f11f11111111111111111111
11111f11f11f11111111111111111111
11f11f11f1f111111111111111111111
111ff111ff1111111111111111111111
11111111111111111111111111111111
11111111111111111111111111111111
11111111111111111111111111111111
`</field><data>{"commentRefs":[],"fieldData":{"img":"m%UOjmz^IBiQZ%C-gAM6"}}</data></block></value><value name="ADD9"><block type="typescript_expression" id="$P_slqx9|/BvFijNU0z!" editable="false"><field name="EXPRESSION">null</field></block></value><value name="ADD10"><block type="screen_image_picker" id="+/rh6_t9qtF}8C)rnjJY"><field name="img">img`
66666666666666666666888888888888
66666666666666666666855555555558
66666666666666666666855555555558
88888888888886666666855555555558
87777777777786666666855555555558
87777777777786666666855555555558
87777777777786666666855555555558
87777777777788888888888885555558
87777777777788555555855585555558
87777777777788555555855585555558
87777777777788555555855585555558
88888888888888555555855585555558
66666666666668555555888888888888
66666666666668555555555586666666
66666666666668555555555586666666
66666666666668555555555586666666
66666666666668888888888886666666
66666666666666666666666666666666
66666666666666666688888888888888
88888888888666666685555555555558
87777777778666666685555555555558
87777777778666666685555555555558
87777777778666666685555555555558
87777777778666666685555555555558
87777777778666666685555555555558
87777777778666666685555555555558
87777777778666666685555555555558
87777777778666666685555555555558
88888888888666666688888888888888
66666666666666666666666666666666
66666666666666666666666666666666
66666666666666666666666666666666
`</field><data>{"commentRefs":[],"fieldData":{"img":"+/rh6_t9qtF}8C)rnjJY"}}</data></block></value><value name="ADD11"><block type="screen_image_picker" id="o5Ew76kl%p2Eyjw]YUlW"><field name="img">img`
99999999999999999999888888888888
99999999999999999999855555555558
99999999999999999999855555555558
88888888888889999999855555555558
87777777777789999999855555555558
87777777777789999999855555555558
87777777777789999999855555555558
87777777777788888888888885555558
87777777777788555555855585555558
87777777777788555555855585555558
87777777777788555555855585555558
88888888888888555555855585555558
99999999999998555555888888888888
99999999999998555555555589999999
99999999999998555555555589999999
99999999999998555555555589999999
99999999999998888888888889999999
99999999999999999999999999999999
99999999999999999988888888888888
88888888888999999985555555555558
87777777778999999985555555555558
87777777778999999985555555555558
87777777778999999985555555555558
87777777778999999985555555555558
87777777778999999985555555555558
87777777778999999985555555555558
87777777778999999985555555555558
87777777778999999985555555555558
88888888888999999988888888888888
99999999999999999999999999999999
99999999999999999999999999999999
99999999999999999999999999999999
`</field><data>{"commentRefs":[],"fieldData":{"img":"o5Ew76kl%p2Eyjw]YUlW"}}</data></block></value><value name="ADD12"><block type="screen_image_picker" id="TDK98+[Q[X?aR?RiCOQp"><field name="img">img`
33333333333333333333333333333333
33333333333333333333333333333333
33333333333333333333333333333333
33333333333333333333333333333333
11111111111111111111111111111111
11111111111111111111111111111111
11111111111111111111111111111111
1111eee11eee1111eee1111eee1eee11
1111eee11eee1111eee1111eee1eee11
1111eee11eee1111eee1111eee1eee11
33333333333333333333333333333333
33333333333333333333333333333333
33333333333333333333333333333333
33333333333333333333333333333333
66666666666666666666666666666666
66666666666666666666666666666666
66666666666666666666666666666666
66666666666666666666666666666666
66666666666666666666666666666666
333eee333eee333eee333eee333eee33
333eee333eee333eee333eee333eee33
333eee333eee333eee333eee333eee33
33333333333333333333333333333333
33333333333333333333333333333333
33333333333333333333333333333333
33333333333333333333333333333333
33333333333333333333333333333333
66666666666666666666666666666666
66666666666666666666666666666666
66666666666666666666666666666666
66666666666666666666666666666666
66666666666666666666666666666666
`</field><data>{"commentRefs":[],"fieldData":{"img":"TDK98+[Q[X?aR?RiCOQp"}}</data></block></value><value name="ADD13"><block type="screen_image_picker" id="+nOr,oU-xRVr8bDSl2]p"><field name="img">img`
99988888888888888888888888888888
99988888888888888888888888888888
99988888888888888888888888888888
55558888888888888888888888888888
55555555555888888888888888888888
55555555555555555555555555555555
55555555555555555555555555555555
55555555555555555555555555555555
55555555555555555555555555555555
55555555555555555555555555555555
55555555555555555555555555555555
55555555555555555555555555555998
99988888888888888888888888888888
98888888888888888888888888888888
88888888888888888888888888888888
88888888888888888888888888888888
88888888888888888888888888888888
88888888888888888888888888888888
88888888888888888888888888888888
88888888888888888888888888888885
55555555555555555555555555555555
55555555555555555555555555555555
55555555555555555555555555555555
55555555555555555555555555555555
55555555555555555555555555555555
55555555555555555555558888888888
55555555555555588888888888888888
55888888888888888888888888888888
55888888888888888888888888888888
99888888888888888888888888888888
99888888888888888888888888999999
99888888888888888889999999999999
`</field><data>{"commentRefs":[],"fieldData":{"img":"+nOr,oU-xRVr8bDSl2]p"}}</data></block></value></block></value><next><block type="typescript_statement" id="yCxPhzjTKjYwF}_)upEK" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="game.stats = true" numlines="1"></mutation><next><block type="variables_set" id="kdU8U}(v}7fdk{O158Ff"><field name="VAR" id="j@M5|/u1:h(EN)@c(W$C">t0</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_index_get" id="OBv7c=q9h)ZXo4jk|`q7"><value name="LIST"><block type="variables_get" id="X3=GLn3LFhHw4L=q#c2["><field name="VAR" id="mLsZhrq0g2Bj4z%;wqSd">textures</field></block></value><value name="INDEX"><shadow type="math_number" id="F;E6WVXV;rre4/IX{d%I"><field name="NUM">0</field></shadow></value></block></value><next><block type="pxt_controls_for" id="4~L#{aABZ4)58hTgye}$"><value name="VAR"><shadow type="variables_get_reporter" id="UFOV3Z?)#-7}P))Jer07"><field name="VAR" id="R)2}Pf{)c%DJC3R+XMrY">i</field></shadow></value><value name="TO"><shadow type="math_whole_number"><field name="NUM">0</field></shadow><block type="math_arithmetic" id="Q:1DYBuLn?0M9pTK@C;I"><field name="OP">MINUS</field><value name="A"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_length" id="drk-|wr66q70_r}-N7hv"><value name="VALUE"><block type="variables_get" id="eCq~)zoH;TW_QMC]J/{z"><field name="VAR" id="mLsZhrq0g2Bj4z%;wqSd">textures</field></block></value></block></value><value name="B"><shadow type="math_number" id="yI$Jd~9)+;0MT3!^w+iC"><field name="NUM">1</field></shadow></value></block></value><statement name="DO"><block type="controls_if" id="e.%xj^0X8*ju0auFW5p/"><mutation else="1"></mutation><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="lists_index_get" id="G1AwZDwur|S9ywjKD$.e"><value name="LIST"><block type="variables_get" id="V1di8qaC~wp9I8|L.1jp"><field name="VAR" id="mLsZhrq0g2Bj4z%;wqSd">textures</field></block></value><value name="INDEX"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="variables_get" id="*hO3E.cY;8(1k)/KQ.eG"><field name="VAR" id="R)2}Pf{)c%DJC3R+XMrY">i</field></block></value></block></value><statement name="DO0"><block type="variables_set" id="_(O3_l)LO~;7)P8ov`Jx"><field name="VAR" id="j@M5|/u1:h(EN)@c(W$C">t0</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_index_get" id="?~,Q@~l#Ki+QFji?6U.3"><value name="LIST"><block type="variables_get" id="VR{pW|8|rxrR*2??.`*3"><field name="VAR" id="mLsZhrq0g2Bj4z%;wqSd">textures</field></block></value><value name="INDEX"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="variables_get" id="MC388a[9P=x7@xwgd(a|"><field name="VAR" id="R)2}Pf{)c%DJC3R+XMrY">i</field></block></value></block></value></block></statement><statement name="ELSE"><block type="lists_index_set" id=",EnV(;Q6:kN-?O4XXpW#"><value name="LIST"><block type="variables_get" id="+Dn@G6bWjosdqoHQQG=("><field name="VAR" id="mLsZhrq0g2Bj4z%;wqSd">textures</field></block></value><value name="INDEX"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="variables_get" id=":@6H~9x7Om}mhBy[YmpU"><field name="VAR" id="R)2}Pf{)c%DJC3R+XMrY">i</field></block></value><value name="VALUE"><block type="variables_get" id="xs;}:XyFXD+#zT,$4q5_"><field name="VAR" id="j@M5|/u1:h(EN)@c(W$C">t0</field></block></value></block></statement></block></statement><next><block type="variables_set" id="3OzY9LYkzF35ncy=2j~k"><field name="VAR" id="q,6kJT*-zq#)=t%U*]=r">fpx</field><value name="VALUE"><shadow type="math_number" id="BkoJ_.pcCvxf5[!Ib`OD"><field name="NUM">10</field></shadow></value><next><block type="variables_set" id="xE]w28({(U|9]*-Js.U|"><field name="VAR" id="i!jlg=$[PH#A[2oloKl.">fpx_scale</field><value name="VALUE"><shadow type="math_number" id="^`7T3[`ANPtG7Nge~9;1"><field name="NUM">1024</field></shadow></value><next><block type="variables_set" id="GK?D1BJ]X%X0K6VnheDy"><field name="VAR" id="*btDK(#/Ff#tL;ux=l+q">fov</field><value name="VALUE"><shadow type="math_number" id="@p:zGx4}S-mA[K3.e1*e"><field name="NUM">0.66</field></shadow></value><next><block type="typescript_statement" id="p4pI(7ebhy$#7E6qKRG@" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="class State {" line1="    x: number" line2="    y: number" line3="    map: Image" line4="    dirX: number" line5="    dirY: number" line6="    planeX: number" line7="    planeY: number" line8="    angle: number" line9="" line10="    constructor() {" line11="        this.angle = 0" line12="        this.x = tofpx(18)" line13="        this.y = tofpx(7)" line14="" line15="        this.setVectors()" line16="        this.map = map.clone()" line17="    }" line18="" line19="    private setVectors() {" line20="        const sin = Math.sin(this.angle)" line21="        const cos = Math.cos(this.angle)" line22="        this.dirX = tofpx(cos)" line23="        this.dirY = tofpx(sin)" line24="        this.planeX = tofpx(sin * fov)" line25="        this.planeY = tofpx(cos * -fov)" line26="    }" line27="" line28="    private canGo(x: number, y: number) {" line29="        return this.map.getPixel(x &gt;&gt; fpx, y &gt;&gt; fpx) == 0" line30="    }" line31="" line32="    updateControls() {" line33="        const dx = controller.dx(2)" line34="        if (dx) {" line35="            this.angle -= dx" line36="            this.setVectors()" line37="        }" line38="        const dy = controller.dy(5)" line39="        if (dy) {" line40="            const nx = this.x - Math.round(this.dirX * dy)" line41="            const ny = this.y - Math.round(this.dirY * dy)" line42="            if (!this.canGo(nx, ny) &amp;&amp; this.canGo(this.x, this.y)) {" line43="                if (this.canGo(this.x, ny))" line44="                    this.y = ny" line45="                else if (this.canGo(nx, this.y))" line46="                    this.x = nx" line47="            } else {" line48="                this.x = nx" line49="                this.y = ny" line50="            }" line51="        }" line52="        //if (dx || dy)" line53="        //    console.log(`${this.x},${this.y},${this.angle}`)" line54="    }" line55="" line56="    trace() {" line57="        // based on https://lodev.org/cgtutor/raycasting.html" line58="        const w = screen.width" line59="        const h = screen.height" line60="        const one = 1 &lt;&lt; fpx" line61="        const one2 = 1 &lt;&lt; (fpx + fpx)" line62="        for (let x = 0; x &lt; w; x++) {" line63="            const cameraX: number = Math.idiv((x &lt;&lt; fpx) &lt;&lt; 1, w) - one" line64="            let rayDirX = this.dirX + (this.planeX * cameraX &gt;&gt; fpx)" line65="            let rayDirY = this.dirY + (this.planeY * cameraX &gt;&gt; fpx)" line66="" line67="            let mapX = this.x &gt;&gt; fpx" line68="            let mapY = this.y &gt;&gt; fpx" line69="" line70="            // length of ray from current position to next x or y-side" line71="            let sideDistX = 0, sideDistY = 0" line72="" line73="            // avoid division by zero" line74="            if (rayDirX == 0) rayDirX = 1" line75="            if (rayDirY == 0) rayDirY = 1" line76="" line77="            // length of ray from one x or y-side to next x or y-side" line78="            const deltaDistX = Math.abs(Math.idiv(one2, rayDirX));" line79="            const deltaDistY = Math.abs(Math.idiv(one2, rayDirY));" line80="" line81="            let mapStepX = 0, mapStepY = 0" line82="" line83="            let sideWallHit = false;" line84="" line85="            //calculate step and initial sideDist" line86="            if (rayDirX &lt; 0) {" line87="                mapStepX = -1;" line88="                sideDistX = ((this.x - (mapX &lt;&lt; fpx)) * deltaDistX) &gt;&gt; fpx;" line89="            } else {" line90="                mapStepX = 1;" line91="                sideDistX = (((mapX &lt;&lt; fpx) + one - this.x) * deltaDistX) &gt;&gt; fpx;" line92="            }" line93="            if (rayDirY &lt; 0) {" line94="                mapStepY = -1;" line95="                sideDistY = ((this.y - (mapY &lt;&lt; fpx)) * deltaDistY) &gt;&gt; fpx;" line96="            } else {" line97="                mapStepY = 1;" line98="                sideDistY = (((mapY &lt;&lt; fpx) + one - this.y) * deltaDistY) &gt;&gt; fpx;" line99="            }" line100="" line101="            let color = 0" line102="" line103="            while (true) {" line104="                //jump to next map square, OR in x-direction, OR in y-direction" line105="                if (sideDistX &lt; sideDistY) {" line106="                    sideDistX += deltaDistX;" line107="                    mapX += mapStepX;" line108="                    sideWallHit = false;" line109="                } else {" line110="                    sideDistY += deltaDistY;" line111="                    mapY += mapStepY;" line112="                    sideWallHit = true;" line113="                }" line114="" line115="                color = this.map.getPixel(mapX, mapY)" line116="                if (color)" line117="                    break; // hit!" line118="            }" line119="" line120="            let perpWallDist = 0" line121="            let wallX = 0" line122="            if (!sideWallHit) {" line123="                perpWallDist = Math.idiv(((mapX &lt;&lt; fpx) - this.x + (1 - mapStepX &lt;&lt; fpx - 1)) &lt;&lt; fpx, rayDirX)" line124="                wallX = this.y + (perpWallDist * rayDirY &gt;&gt; fpx);" line125="            } else {" line126="                perpWallDist = Math.idiv(((mapY &lt;&lt; fpx) - this.y + (1 - mapStepY &lt;&lt; fpx - 1)) &lt;&lt; fpx, rayDirY)" line127="                wallX = this.x + (perpWallDist * rayDirX &gt;&gt; fpx);" line128="            }" line129="            wallX &amp;= (1 &lt;&lt; fpx) - 1" line130="" line131="            color = (color - 1) * 2" line132="            if (sideWallHit) color++" line133="" line134="            const tex = textures[color]" line135="            if (!tex)" line136="                continue" line137="" line138="            // textures look much better when lineHeight is odd" line139="            let lineHeight = Math.idiv(h &lt;&lt; fpx, perpWallDist) | 1;" line140="            let drawStart = (-lineHeight + h) &gt;&gt; 1;" line141="" line142="            let texX = (wallX * tex.width) &gt;&gt; fpx;" line143="            if ((!sideWallHit &amp;&amp; rayDirX &gt; 0) || (sideWallHit &amp;&amp; rayDirY &lt; 0))" line144="                texX = tex.width - texX - 1;" line145="" line146="            screen.blitRow(x, drawStart, tex, texX, lineHeight)" line147="            /*" line148="                        const texStepY = Math.idiv(tex.height &lt;&lt; fpx, lineHeight)" line149="                        let texY = 0" line150="                        let i = 0" line151="                        if (drawStart &lt; 0) {" line152="                            i = -drawStart" line153="                            texY = i * texStepY" line154="                            lineHeight += drawStart + 1" line155="                        }" line156="                        for (; i &lt; lineHeight; ++i) {" line157="                            screen.setPixel(x, drawStart + i, tex.getPixel(texX, texY &gt;&gt; fpx))" line158="                            texY += texStepY" line159="                        }" line160="                        */" line161="" line162="        }" line163="    }" line164="}" numlines="165"></mutation><next><block type="typescript_statement" id="m+A,95!a*R2Qsn3OYFXy" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="const st = new State()" numlines="1" declaredvars="st"></mutation><next><block type="typescript_statement" id="ks}-M+A8IP0Wy*.iFa9]" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="game.onPaint(function () {" line1="    st.trace()" line2="})" numlines="3"></mutation></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type="gameupdate" id="sS^@eG,$Wix+y.o6yu-M" x="1045" y="0"><statement name="HANDLER"><block type="typescript_statement" id=";s$3a*U:vYqSZfc8ne/k" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="st.updateControls()" numlines="1"></mutation></block></statement></block><block type="function_definition" id=":Z7*SbUMnwX%DdDn4o*n" x="1289" y="0"><mutation name="tofpx" functionid="4Mp]SJA8U_TvWg@9wEz0"><arg name="n" id="gg0tny6hhq7efu9ondny" type="number"></arg></mutation><field name="function_name">tofpx</field><statement name="STACK"><block type="function_return" id="tM*(Xc6$}OJ#Oy4k|*Q~"><mutation xmlns="http://www.w3.org/1999/xhtml" no_return_value="false"></mutation><value name="RETURN_VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="typescript_expression" id="uvPN7z(FDt.|.2{F7S9z" editable="false"><field name="EXPRESSION">(n * fpx_scale) | 0</field></block></value></block></statement></block></xml>